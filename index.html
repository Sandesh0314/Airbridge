<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AirBridge Web</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glow {
      color: #0ff;
      text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff;
    }
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .drop-area {
      border: 2px dashed #60a5fa;
      background: rgba(255,255,255,0.05);
      transition: all 0.3s;
    }
    .drop-area:hover {
      background: rgba(255,255,255,0.1);
      border-color: #3b82f6;
    }
    #progressBar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #222;
    }
    #progressBarFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #00f260, #0575e6);
    }
    #qrScannerContainer {
      width: 100%;
      height: 300px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: black;
      margin-top: 1rem;
    }
    #cancelBtn {
      margin-top: 0.5rem;
      padding: 0.5rem 1.5rem;
      background: #ef4444;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      color: white;
      display: none;
    }
    #cancelBtn:hover {
      background: #dc2626;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-gray-900 min-h-screen text-white flex items-center justify-center">

<div id="landing" class="text-center p-10">
  <h1 class="text-5xl font-bold glow mb-6">AirBridge Web</h1>
  <button onclick="showMain()" class="mt-5 px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-full text-xl">Enter</button>
</div>

<div id="mainUI" class="hidden flex flex-col items-center space-y-6 p-6">
  <div class="glass p-6">
    <h2 class="text-3xl font-semibold mb-4">Choose Action</h2>
    <div class="flex space-x-4">
      <button onclick="showSend()" class="px-6 py-3 bg-green-500 hover:bg-green-600 rounded-xl text-lg">üì§ Send File</button>
      <button onclick="showReceive()" class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-lg">üì• Receive File</button>
    </div>
  </div>

  <div id="sendUI" class="hidden w-full max-w-md glass p-6 flex flex-col space-y-4">
    <label for="fileInput" class="drop-area cursor-pointer text-center py-6 px-4 rounded-xl">
      <span class="text-lg">üìÅ Tap or Drag to select files (Max 30)</span>
      <input id="fileInput" type="file" accept="image/*,video/*,.pdf,.doc,.zip" multiple onchange="handleFileSelection()" class="hidden" />
    </label>

    <ul id="fileList" class="text-left text-sm mb-2 space-y-1 list-disc list-inside"></ul>
    <button id="sendNowBtn" onclick="startQRScan()" class="hidden bg-gradient-to-r from-green-400 to-blue-500 text-white py-2 px-6 rounded-lg shadow-lg hover:scale-105">üöÄ Send Now</button>

    <div id="qrScannerContainer" class="hidden"></div>
    <button id="cancelBtn" onclick="cancelQR()">Cancel Scan</button>

    <div id="progressBar" class="w-full hidden">
      <div id="progressBarFill"></div>
    </div>
  </div>

  <div id="receiveUI" class="hidden glass p-4 text-center">
    <h3 class="text-lg mb-2">Scan This QR Code</h3>
    <canvas id="qrCanvas"></canvas>
    <p id="sessionIdText" class="text-xs mt-2"></p>
    <div id="receivedFiles" class="mt-4 text-left max-h-48 overflow-y-auto"></div>
  </div>
</div>

<script>
  let peer, conn, selectedFiles = [];
  let scanner = null;

  function showMain() {
    document.getElementById('landing').classList.add('hidden');
    document.getElementById('mainUI').classList.remove('hidden');
  }

  function showSend() {
    document.getElementById('sendUI').classList.remove('hidden');
    document.getElementById('receiveUI').classList.add('hidden');
  }

  function showReceive() {
    document.getElementById('receiveUI').classList.remove('hidden');
    document.getElementById('sendUI').classList.add('hidden');
    setupReceiver();
  }

  function handleFileSelection() {
    const input = document.getElementById('fileInput');
    const list = document.getElementById('fileList');
    const sendNowBtn = document.getElementById('sendNowBtn');

    if (input.files.length > 30) {
      alert('Please select up to 30 files.');
      input.value = '';
      return;
    }

    selectedFiles = [...input.files];
    list.innerHTML = '';
    selectedFiles.forEach(file => {
      const li = document.createElement('li');
      li.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;
      list.appendChild(li);
    });

    sendNowBtn.classList.remove('hidden');
  }

  function startQRScan() {
    const container = document.getElementById('qrScannerContainer');
    const cancelBtn = document.getElementById('cancelBtn');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(() => {
        container.classList.remove('hidden');
        cancelBtn.style.display = "inline-block";

        if (scanner) scanner.clear().catch(() => {});
        scanner = new Html5Qrcode("qrScannerContainer");

        Html5Qrcode.getCameras().then(cameras => {
          if (!cameras.length) return alert("No camera found.");
          const camId = cameras[0].id;

          scanner.start(
            { deviceId: { exact: camId } },
            { fps: 10, qrbox: 250 },
            sessionId => {
              scanner.stop().then(() => {
                scanner.clear();
                container.classList.add('hidden');
                cancelBtn.style.display = "none";
                connectToReceiver(sessionId);
              });
            },
            error => console.warn("Scan error", error)
          ).catch(err => {
            alert("Failed to start scanner: " + err);
          });
        });
      })
      .catch(err => {
        alert("Camera access denied. Please allow it.");
      });
  }

  function cancelQR() {
    if (scanner) {
      scanner.stop().then(() => {
        scanner.clear().catch(() => {});
        document.getElementById('qrScannerContainer').classList.add('hidden');
        document.getElementById('cancelBtn').style.display = "none";
      }).catch(console.error);
    }
  }

  function connectToReceiver(id) {
    peer = new Peer();
    peer.on('open', () => {
      conn = peer.connect(id);
      conn.on('open', () => {
        const progressBar = document.getElementById('progressBar');
        const fill = document.getElementById('progressBarFill');
        progressBar.classList.remove('hidden');

        let index = 0;
        function sendNext() {
          if (index >= selectedFiles.length) {
            alert("üì§ File(s) sent successfully!");
            progressBar.classList.add('hidden');
            return;
          }
          const file = selectedFiles[index];
          const reader = new FileReader();
          reader.onload = () => {
            conn.send({ name: file.name, data: reader.result });
            fill.style.width = `${((index + 1) / selectedFiles.length) * 100}%`;
            index++;
            sendNext();
          };
          reader.readAsArrayBuffer(file);
        }
        sendNext();
      });
    });
  }

  function setupReceiver() {
    const sessionId = Math.random().toString(36).substring(2, 10);
    peer = new Peer(sessionId);
    document.getElementById('sessionIdText').innerText = `Session ID: ${sessionId}`;
    QRCode.toCanvas(document.getElementById('qrCanvas'), sessionId);
    peer.on('connection', connection => {
      connection.on('data', file => {
        const blob = new Blob([file.data]);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = file.name;
        link.click();
        const p = document.createElement('p');
        p.textContent = `‚úÖ Received: ${file.name}`;
        document.getElementById('receivedFiles').appendChild(p);
      });
    });
  }
</script>
</body>
</html>
